<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Excelâ†’HTMLå¤‰æ›</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!--const firstSheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[firstSheetName];
const htmlString = XLSX.utils.sheet_to_html(worksheet);
ã“ã‚Œã§ã„ããªã‚ŠHTMLå¤‰æ›ã§ãã‚‹ã€‚ã‚»ãƒ«çµåˆãªã©èª¿æŸ»ã™ã‚‹å¿…è¦ãªã—ï¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ³¨æ„ 18ã§ã¯å‹•ã‹ãªã„-->

<!-- ãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒãƒ»ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ãƒªã‚µã‚¤ã‚ºãªã©ã¯ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„ã»ã†ãŒã‚ˆã„
 ã¤ã¾ã‚Šæ™®é€šã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãŒãŠã™ã™ã‚ -->

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”¨</text></svg>">
</head>

<body>

    <div id="drop-area">ã“ã“ã«Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsxï¼‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
    <div id="output"></div>
    <button id="toggle-source" style="margin-top: 10px;">â–¼ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</button>
    <div id="source-area" style="display:none;">
        <pre id="source"
            style="background:#f8f8f8; border:1px solid #ccc; padding:8px; margin-top:10px; overflow:auto;"></pre>
    </div>
    <button id="copy-btn" style="margin-top:5px;">ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>

    <script>
        // TODO: âš ãƒ‡ãƒ¼ã‚¿ãŒãƒ•ã‚¡ã‚¤ãƒ«åã ã‘ã®æ™‚ã¯ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…ˆé ­ã«ä»˜ã‘ã‚‹ã¨å…¨éƒ¨ã¤ã
        const file_dir = "./files/support/common/"; 
        
        /* ================================
           DOMå–å¾—
        ================================ */
        const dropArea = document.getElementById('drop-area');
        const output = document.getElementById('output');
        const source = document.getElementById('source');
        const copyBtn = document.getElementById('copy-btn');
        const toggleBtn = document.getElementById('toggle-source');
        const sourceArea = document.getElementById('source-area');
        initEvents();

        //ä»¥é™ã™ã¹ã¦å…ƒã‚³ãƒ¼ãƒ‰ã‚’é–¢æ•°åŒ–ã—ã¦ç§»å‹•ã—ãŸã ã‘
        //DOMå¤‰æ•°.addEventListener('ã‚¤ãƒ™ãƒ³ãƒˆå', é–¢æ•°å);
        /* ================================
           ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
        ================================ */
        function initEvents() {
            toggleBtn.addEventListener('click', toggleSource); // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è¡¨ç¤º/éè¡¨ç¤ºãƒœã‚¿ãƒ³

            //ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã¯å„ç¨®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
            dropArea.addEventListener('dragover', onDragOver); // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
            dropArea.addEventListener('dragleave', onDragLeave); // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
            dropArea.addEventListener('drop', handleFileDrop); // ãƒ‰ãƒ­ãƒƒãƒ—

            copyBtn.addEventListener('click', copySource); // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
        }

        // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è¡¨ç¤º/éè¡¨ç¤ºåˆ‡æ›¿
        function toggleSource() {
            if (sourceArea.style.display === "none") {
                sourceArea.style.display = "";
                toggleBtn.textContent = "â–² ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’éš ã™";
            } else {
                sourceArea.style.display = "none";
                toggleBtn.textContent = "â–¼ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º";
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
        function onDragOver(e) {
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œç„¡åŠ¹åŒ–
            dropArea.style.background = "#eef";
        }

        function onDragLeave(e) {
            e.preventDefault();
            dropArea.style.background = "";
        }

        /* ================================
           ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«å—ã‘å–ã‚Š
           ï¼ˆï¼‘ã¤ã®ã¿ã€‚ï¼’ã¤ç›®ä»¥é™ã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼‰ã€‚
           èª­ã¿è¾¼ã¿å‡¦ç†ã¯handleFileLoadedã¸å§”è­²
        ================================ */
        function handleFileDrop(e) {
            e.preventDefault();
            dropArea.style.background = "";

            const file = e.dataTransfer.files[0]; //ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‹ã‚‰ã€Œæœ€åˆã®1å€‹ã€ã‚’å–ã‚Šå‡ºã™
            if (!file) return; //ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã‘ã‚Œã°ã€ã“ã“ã§é–¢æ•°çµ‚äº†ã€‚ä½•ã‚‚è¿”ã•ãªã„

            const reader = new FileReader(); //ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã® FileReader ã‚’ä½œã‚‹

            // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ã“ã“ãŒå‘¼ã°ã‚Œã‚‹
            // evt.target.result ã«ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ãŒå…¥ã£ã¦ã„ã‚‹
            reader.onload = function (evt) {
                handleFileLoaded(evt);
            };

            // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆéåŒæœŸï¼‰
            reader.readAsArrayBuffer(file);
        }

        /* ================================
           Excelèª­ã¿è¾¼ã¿å¾Œ
        ================================ */
        function handleFileLoaded(evt) {
            const data = new Uint8Array(evt.target.result); // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’Uint8Arrayï¼ˆå‹ä»˜ãé…åˆ—ã§ã€ 8ãƒ“ãƒƒãƒˆç¬¦å·ãªã—æ•´æ•°å€¤ã®é…åˆ—ï¼‰ã¨ã—ã¦å–å¾—
            const workbook = XLSX.read(data, { type: 'array' }); //XLSX ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦è§£æã€‚type: 'array' â†’ Uint8Array ã‚’æ¸¡ã™æŒ‡å®š
            const sheet = workbook.Sheets[workbook.SheetNames[0]];

            // ã‚·ãƒ¼ãƒˆã‚’ã€Œè¡Œ Ã— åˆ—ã®é…åˆ—ã€ã«å¤‰æ›
            // header: 1 â†’ 1è¡Œç›®ã‚’ãƒ˜ãƒƒãƒ€æ‰±ã„ã›ãšã€ç´”ç²‹ãªé…åˆ—ã«ã™ã‚‹
            // blankrows: false â†’ ç©ºè¡Œã¯é™¤å¤–
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });//rowsã«ã¯ï¼’æ¬¡å…ƒé…åˆ—ãŒå…¥ã‚‹

            // è¦‹å‡ºã—æ–‡å­—åˆ— â†’ CSSã‚¯ãƒ©ã‚¹å ã®å¯¾å¿œè¡¨
            //  HTMLç”Ÿæˆæ™‚ã«ä½¿ã†ãŸã‚ã®å®šç¾©
            const headerClassMap = {
                "ç”Ÿå¾’ç”¨": "student",
                "æ•™å¸«ç”¨": "teacher",
                "ç®¡ç†ç”¨": "admin",
            };

            const fileCols = detectFileCols(rows); //ãƒ˜ãƒƒãƒ€è¡Œã‚’èª¿æŸ»ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«åˆ—ã‚’ç‰¹å®š
            const spanMap = buildSpanMap(sheet, rows);
            const html = buildHTML(rows, spanMap, fileCols, headerClassMap);

            output.innerHTML = html;  //ç”Ÿæˆã—ãŸ HTML ã‚’ç”»é¢ã«è¡¨ç¤º
            source.textContent = html;// ç”Ÿæˆã—ãŸ HTML ã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã«ã‚»ãƒƒãƒˆ
        }

        /* ================================
           ãƒ˜ãƒƒãƒ€è¡Œã®èª¿æŸ»
        ================================ */
        function detectFileCols(rows) { 
            const fileCols = {};
            const header = rows[0] || []; //rows[0] ãŒ å­˜åœ¨ã™ã‚Œã°headerã«ä»£å…¥undefinedï¼ˆè¡ŒãŒ1ã¤ã‚‚ãªã„ï¼‰ãªã‚‰ []
            for (let c = 0; c < header.length; c++) {
                const val = String(header[c] || "").toLowerCase();
                if (val.includes("word")) fileCols[c] = "doc";
                else if (val.includes("pdf")) fileCols[c] = "pdf";
                else if (val.includes("excel") || val.includes("xlsx")) fileCols[c] = "xlsx";
                else if (val.includes("text")) fileCols[c] = "txt";
            }
            return fileCols; // { åˆ—ç•ªå·: ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥ } ã®jsonã§è¿”ã™
        }

        function buildSpanMap(sheet, rows) {
            const merges = sheet["!merges"] || []; //ã‚·ãƒ¼ãƒˆå†…ã®çµåˆã‚»ãƒ«æƒ…å ±ã‚’å–å¾—(jsoné…åˆ—)
            const spanMap = {};

            for (const merge of merges) {
                const r0 = merge.s.r, c0 = merge.s.c;
                const r1 = merge.e.r, c1 = merge.e.c;

                spanMap[`${r0},${c0}`] = {
                    rowspan: r1 - r0 + 1,
                    colspan: c1 - c0 + 1
                };

                for (let r = r0; r <= r1; r++) {
                    if (!rows[r]) rows[r] = [];
                    for (let c = c0; c <= c1; c++) {
                        if (r === r0 && c === c0) continue;
                        rows[r][c] = null;
                    }
                }
            }
            return spanMap;
        }

        function buildHTML(rows, spanMap, fileCols, headerClassMap) {
            let html = '<table class="thinTable webSupportTable">\n'; // æ—¢å­˜ã‚¯ãƒ©ã‚¹ï¼ˆcssï¼‰ã‚’ç¶­æŒ

            for (let r = 0; r < rows.length; r++) {
                let downloadAllCol = -1;
                for (let c = 0; c < (rows[r]?.length || 0); c++) {
                    if (String(rows[r][c]).trim() === "ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰") {
                        downloadAllCol = c;
                        break;
                    }
                }

                html += '  <tr>\n';

                for (let c = 0; c < (rows[r]?.length || 0); c++) {
                    const cell = rows[r][c];
                    if (cell === null) continue;

                    let attrs = "";
                    const span = spanMap[`${r},${c}`];
                    if (span) {
                        if (span.rowspan > 1) attrs += ` rowspan=\"${span.rowspan}\"`;
                        if (span.colspan > 1) attrs += ` colspan=\"${span.colspan}\"`;
                    }

                    let content = cell !== undefined ? cell : "";
                    let tdClass = "";

                    if (r === 0 && typeof content === "string") {
                        for (const [key, className] of Object.entries(headerClassMap)) {
                            if (content.includes(key)) {
                                tdClass = ` class=\"${className}\"`;
                                break;
                            }
                        }
                    }

                    if (downloadAllCol >= 0 && c >= downloadAllCol) {
                        tdClass = tdClass
                            ? tdClass.replace('"', ' download-all"')
                            : ' class="download-all"';
                    }

                    const cellTag = (r === 0) ? "th" : "td";

                    if (r > 0 && fileCols[c] && cell) {
                        const icon = `/files/support/common/icon/${fileCols[c]}.png`;
                        content = `<a href=\"${file_dir}${cell}\"><img src=\"${icon}\" alt=\"${fileCols[c]}\" width=\"30\" height=\"30\" style=\"display:block;margin:auto;\" /></a>`;
                    }

                    html += `    <${cellTag}${tdClass}${attrs}>${content}</${cellTag}>\n`;
                }
                html += '  </tr>\n';
            }
            html += '</table>\n';
            html += '\n<style>\n    .webSupportTable {\n        width: 100%;\n        border-collapse: collapse;\n        font-family: "Shin Go Regular", "Yu Gothic", æ¸¸ã‚´ã‚·ãƒƒã‚¯, "Hiragino Kaku Gothic ProN", "Hiragino Kaku Gothic Pro", "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro W3", ãƒ¡ã‚¤ãƒªã‚ª, Meiryo, sans-serif;\n    }\n    .webSupportTable tr{\n        height: 32px;\n    }\n    .webSupportTable td{\n        font-size: 18px;\n    }\n    .webSupportTable th{\n        background-color: white;\n        text-align: center;\n        font-size: 16px;\n    }\n    .download-all{\n        background-color: beige\n    }\n    .webSupportTable th.student{\n        background-color: #ced4d9;\n\n    }\n    .webSupportTable th.teacher{\n        background-color: #f8cac6;\n    }\n    .horizontal-padding-zero{\n        padding-left: 0 !important;\n        padding-right: 0 !important;\n    }\n    .file-format{\n        font-size: 14px;\n    }\n    .diagonal_line_l {\n      background-image: linear-gradient(to right top, transparent calc(50% - 0.4px), rgba(128, 128, 128, 0.5) 50%, rgba(128, 128, 128, 0.5) calc(50% + 0.4px), transparent calc(50% + 0.8px)); \n    }\n    .diagonal_line_r {\n      background-image: linear-gradient(to left top, transparent calc(50% - 0.4px), rgba(128, 128, 128, 0.5) 50%, rgba(128, 128, 128, 0.5) calc(50% + 0.4px), transparent calc(50% + 0.8px)); \n    }\n</style>';
            return html;
        }

        function copySource() {
            navigator.clipboard.writeText(source.textContent);
            copyBtn.textContent = "ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
            setTimeout(() => { copyBtn.textContent = "ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼"; }, 1200);
        }
    </script>

    <style>
        #drop-area {
            border: 2px dashed #888;
            padding: 40px;
            text-align: center;
            color: #888;
            margin-bottom: 20px;
        }

        table {
            border-collapse: collapse;
        }

        td,
        th {
            border: 1px solid #ccc;
            padding: 4px 8px;
        }
    </style>
</body>

</html>
